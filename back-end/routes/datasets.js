var express = require('express');
var router = express.Router();
// var firebase = require('firebase-admin');
var firebase = require("../lib/FirebaseService");
var database = firebase.database();

//get datasets from database
router.get('/', async function(req,res){
    console.log('get request to datasets, sending everything in datasets node');

    const thisDBRef = await database.ref(`datasets`);

    let formattedData = null;
    await thisDBRef.once("value", async data => {
        formattedData = await data.val();
    });
    formattedData = JSON.stringify(formattedData);
    res.type('json');
    console.log('sending this data: '+formattedData);
    res.send(formattedData);
    
})

//post new dataset to database
router.post('/', function(req, res, next) {
    const asyncWrapper = async()=>{
     const body = await req.body;
  // body format...
//   {"meta":
        {
//       "longName":"",
//       "label":"",
//       "sourceLink":"",
//      },
//   "country1":"",
//   "country2":"",
//   }
    
    //make sure the dataset label and longname dont already exist
    //post to the 'datasets' table AND post each datapoint to its respectivee
    //country's table

    //post to database
    console.log('sending ',body, ' to database');
    var datasetsRef = await database.ref('datasets');
    const newDatasetRef = await datasetsRef.push(body);
    const datasetKey = newDatasetRef.key;
    //now push to each country's table
    await Object.keys(body).forEach(async country=>{
        //ignore the first object key which will be 'meta'
        if (country==='meta')return;
        const currentRef = await database.ref('countries/'+country);
        //use the unique key for the dataset, generated by realtime database, to identify this data
        currentRef.child(datasetKey).set(body[country]); 
    });
    //update the datasets meta info
    const datasetsMetaRef = await database.ref('datasets/meta');
    //longNameList also used to count datasets
    datasetsMetaRef.child('longNames').child(datasetKey).set(body[meta][longName]);

  res.type('text');
  res.send('Successfully posted new dataset to database');
}
    }
asyncWrapper();
});

// router.get('/scores/q',function(req,res,next){
//     const thisDatasetID = req.query.datasetID;
//     const thisIdealVal = req.query.val;
//     const weight = req.query.weight;
//     //return a list of countries with their respective scores (multiplied by weight)
    
// })



module.exports = router;